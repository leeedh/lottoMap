# 📄 Product Requirements Document (PRD)

**제품명**: 로또 명당 서비스 (LuckyMap Korea)
**현재 상태**: MVP 개발 중 (목업 데이터 기반)
**기술 스택**: React + Vite (SPA), Kakao Map API, Tailwind CSS

---

## 1. 제품 개요

### 목적

사용자들이 전국 로또 당첨 판매점(“명당”) 정보를 직관적으로 확인하고 즐길 수 있는 지도 기반 서비스.

* **문제**: 현재 동행복권 사이트의 당첨 판매점 정보는 HTML 테이블 형식으로만 제공되어 접근성이 낮고, 지역별 비교나 시각화가 어렵다.
* **해결**: 지도 기반 인터페이스로 데이터를 시각화하고, 랭킹/통계로 가공하여 **쉽고 재미있게** 제공한다.
  * 현재는 목업 데이터로 프로토타입 구현 중이며, 향후 실제 데이터 크롤링 및 API 연동 예정.

### 가치 제안

* **사용자**: 전국 당첨 명당 위치와 누적 이력, 랭킹을 한눈에 확인.
* **사업자(운영자)**: 트래픽 기반 광고 및 지역 스폰서십 등 수익화 가능.
* **기술적 차별성**: 매주 자동 업데이트(토요일 추첨 직후), 지오코딩을 통한 위치 기반 시각화.

---

## 2. 대상 사용자

1. **로또 구매자 (일반인)**

   * 니즈: 당첨 확률이 높은 ‘명당’을 방문하거나 참고하고 싶음.
   * 문제점: 공식 사이트는 불편하고 직관적이지 않음.

2. **데이터/트렌드 관심 사용자**

   * 니즈: 당첨 분포, 지역별 차이, 누적 당첨 랭킹 같은 통계적 재미.
   * 문제점: 데이터가 구조화되어 있지 않아 개인이 분석하기 어려움.

3. **운영자/광고주**

   * 니즈: 명당 방문자층을 대상으로 광고 노출.
   * 문제점: 기존에 관련 광고 노출 플랫폼이 부족함.

---

## 3. 사용자 흐름

### 시나리오 1: 사용자가 명당 탐색 (현재 구현됨)

1. 메인 화면 접속 → 좌측 사이드바와 우측 지도 영역이 로딩됨.
2. 좌측 사이드바에서 복권 종류 필터 선택 (로또 6/45, 연금복권) → 지도에서 해당 종류의 판매점이 마커로 표시됨.
3. 지도 마커 클릭 또는 사이드바의 판매점 카드 클릭 → 인포윈도우/카드 확장으로 상세 정보 표시 (누적 1등/2등 횟수, 최근 당첨 회차, 주소, 위치).

### 시나리오 2: 사용자가 랭킹 확인 (현재 구현됨)

1. 메인 화면 → 좌측 사이드바의 "전체 랭킹" 탭 선택.
2. 지역 필터(시/도, 시/군/구) 선택으로 지역별 Top 판매점 확인.
3. 판매점 카드 클릭 시 지도에서 해당 위치로 이동 및 상세 정보 표시.

### 시나리오 3: 매주 데이터 업데이트 (향후 구현 예정)

1. 토요일 21:10 KST → GCP Cloud Scheduler가 `etl-crawler` 실행 (예정).
2. 최신 회차/판매점 HTML 파싱 → 주소 정규화 후 지오코딩 큐에 발행 (예정).
3. `geocode-worker`가 Kakao API로 좌표 변환 후 DB 반영 (예정).
4. 사용자들은 새로고침 시 최신 회차 반영된 데이터 확인 가능 (예정).

---

## 4. 기능 요구사항

### 핵심 기능 (MVP)

| 기능               | 설명                                        | 상태 | 우선순위 |
| ---------------- | ----------------------------------------- | --- | ---- |
| **지도 기반 판매점 표시** | Kakao Map API로 전국 명당 시각화. 커스텀 마커로 1등/2등 구분 표시. | ✅ 구현됨 | 상    |
| **판매점 필터링**    | 좌측 사이드바에서 복권 종류 필터 (로또 6/45, 연금복권). | ✅ 구현됨 | 상    |
| **판매점 상세 정보**   | 인포윈도우 및 카드 확장으로 주소, 지도 위치, 누적 당첨 횟수, 최근 당첨 회차, 회차별 이력 표시. | ✅ 구현됨 | 상    |
| **랭킹 기능**       | 전국/지역별 Top 판매점 리스트 제공 (지역 필터 지원). | ✅ 구현됨 | 상    |
| **모바일 반응형**    | 모바일 환경에서 사이드바 드로어, 플로팅 필터/버튼 지원. | ✅ 구현됨 | 상    |
| **자동 데이터 업데이트**  | 매주 추첨 직후 크론잡으로 최신 회차 데이터 수집/DB 반영. | 🔄 향후 구현 | 상    |

### 확장 기능

| 기능            | 설명                              | 난이도 | 우선순위 |
| ------------- | ------------------------------- | --- | ---- |
| **히트맵**       | 지역별 당첨 밀도 시각화.                  | 보통  | 중    |
| **사용자 후기/제보** | 판매점 경험담, 신규 제보 등록. 운영자 승인 후 반영. | 보통  | 중    |
| **오늘의 추천 명당** | 랜덤/가중치 기반 추천.                   | 쉬움  | 하    |

### 수익화 기능

| 기능                | 설명                      | 난이도 | 우선순위 |
| ----------------- | ----------------------- | --- | ---- |
| **광고 배너/네이티브 광고** | 좌측 패널 내 검색창 하단/랭킹 리스트에 광고 슬롯 삽입. | 쉬움  | 중    |
| **지역 스폰서십**       | 특정 지역 판매점 주변 광고.        | 보통  | 하    |

---

## 5. 기술 아키텍처

### 현재 구현 (MVP)

* **Frontend**: React 18 + Vite (SPA)
* **지도**: Kakao Map API (JavaScript SDK)
* **스타일링**: Tailwind CSS (CDN)
* **아이콘**: Lucide React
* **데이터**: 목업 데이터 (MOCK_STORES in `constants.ts`)
* **타입**: TypeScript

### 향후 확장 계획 (GCP Cloud Run 기반)

* **Frontend & API**: Next.js 앱 (Cloud Run 서비스, `asia-northeast3`) - 예정
* **Database**: Supabase (Postgres, 별도 관리) - 예정
* **ETL Crawler**: Cloud Run Job (`etl-crawler`) - 예정
* **Geocoding Worker**: Cloud Run Service (`geocode-worker`) + Pub/Sub 구독 - 예정
* **Scheduler**: Cloud Scheduler (토요일 21:10, HTTP 트리거) - 예정
* **Queue**: Pub/Sub (지오코딩 요청 큐) - 예정
* **Secrets**: Secret Manager (Supabase 키, Kakao API Key 등) - 예정
* **Monitoring**: Cloud Logging + Error Reporting - 예정

---

## 6. 데이터 파이프라인

### 현재 상태

* **데이터 소스**: 목업 데이터 (`constants.ts`의 `MOCK_STORES`)
* **데이터 구조**: TypeScript 인터페이스로 정의 (`types.ts`)
  * `Store`: 판매점 정보 (이름, 주소, 좌표, 당첨 통계, 이력)
  * `WinRecord`: 당첨 기록 (회차, 등수, 방법, 날짜)
  * `WinStats`: 당첨 통계 (로또 1등, 로또 2등, 연금복권)

### 향후 구현 계획

1. **Crawler**

   * (권장) 최신 회차 JSON/엔드포인트로 회차 메타 확인 → 회차별 당첨 판매점 페이지(HTML) 파싱 → 정규화 → Pub/Sub 메시지 발행
   * 원천이 CSV/HTML 등으로 바뀌더라도, 아래 “정규화 결과 스키마”는 동일하게 유지(문서 간 계약)

2. **Geocode Worker**

   * 메시지 수신 → geocode\_cache 조회 → Kakao API 호출 → Supabase DB 업데이트

3. **DB 구조 (핵심)**

   * `draws`: 회차
   * `stores`: 판매점(정규화/좌표 포함)
   * `winning_records`: 회차별 당첨 기록
   * `geocode_cache`: 주소 → 좌표 캐시
   * `job_runs`: 작업 로그

4. **Idempotency(중복 방지)**

   * `winning_records.source_row_hash`를 기준으로 **idempotent upsert** 수행
   * 해시 입력에는 최소 `round_no`, `lottery_type`, `source_store_id(or store_id)`, `rank`를 포함(동일 회차 중복 적재 방지)

---

## 7. 운영/정책

### 현재 상태

* **데이터**: 목업 데이터 사용 중 (개발/프로토타입 단계)
* **면책**: 데이터는 참고용, 공식 당첨 정보는 동행복권 확인 권장

### 향후 운영 계획

* **업데이트 주기**: 매주 토요일 21:10 (추첨 직후) - 예정
  * 스케줄러 타임존: `Asia/Seoul`로 고정(UTC 혼동 방지)
* **데이터 출처 명시**: "동행복권 공개 페이지/엔드포인트" - 예정
* **레이트 리밋 대응**: API 호출 간격 조정 + 캐시 활용 - 예정
* **알림/관제**: 크롤 실패, API 호출 실패율 증가 시 Slack/Webhook - 예정

---

## 8. 향후 로드맵

### 단계 1: MVP 완성 (진행 중)

1. ✅ 프론트엔드 MVP 구현 (지도/필터/랭킹/상세)
2. 🔄 실제 데이터 연동 (크롤링/지오코딩/DB)
3. 🔄 백엔드 API 구축

### 단계 2: 기능 확장

1. 히트맵 시각화
2. 후기/제보 시스템
3. 추천 명당 기능

### 단계 3: 수익화

1. 광고 배너 도입 → 지역 스폰서십 확장
2. 필요 시 Supabase → Cloud SQL(Postgres) 마이그레이션

---